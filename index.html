<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#06060e">
    <title>TradeVault Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
:root {
    --mint: #00F0A0;
    --mint-dim: rgba(0,240,160,0.12);
    --mint-glow: rgba(0,240,160,0.35);
    --red: #FF3B5C;
    --red-dim: rgba(255,59,92,0.12);
    --red-glow: rgba(255,59,92,0.35);
    --sky: #38B6FF;
    --sky-dim: rgba(56,182,255,0.12);
    --amber: #FFB830;
    --amber-dim: rgba(255,184,48,0.12);
    --violet: #B36CFF;
    --violet-dim: rgba(179,108,255,0.12);
    --gold: #FFD700;

    --bg-0: #06060e;
    --bg-1: #0c0c18;
    --bg-2: #131325;
    --bg-3: #1c1c35;
    --bg-4: #262645;

    --text-0: #FFFFFF;
    --text-1: #D0D0E8;
    --text-2: #8888AA;
    --text-3: #555570;

    --border: rgba(255,255,255,0.05);
    --border-l: rgba(255,255,255,0.08);
    --r-sm: 10px; --r-md: 14px; --r-lg: 20px; --r-xl: 28px;
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:100%;overflow:hidden}
body{
    font-family:'Outfit',sans-serif;
    background:var(--bg-0);
    color:var(--text-0);
    max-width:430px;
    margin:0 auto;
    height:100%;
    overflow:hidden;
    -webkit-font-smoothing:antialiased;
    position:relative;
}
.mono{font-family:'JetBrains Mono',monospace}

.app{height:100%;display:flex;flex-direction:column}

/* ====== TOASTS ====== */
.toast-box{position:fixed;top:max(env(safe-area-inset-top),10px);left:50%;transform:translateX(-50%);z-index:9999;width:calc(100% - 28px);max-width:410px;pointer-events:none;display:flex;flex-direction:column;gap:6px}
.toast{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:var(--r-md);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);font-size:13px;font-weight:600;transform:translateY(-20px);opacity:0;animation:tIn .35s cubic-bezier(.34,1.56,.64,1) forwards;pointer-events:auto;box-shadow:0 8px 32px rgba(0,0,0,.6)}
.toast.out{animation:tOut .25s ease forwards}
.toast i{font-size:16px;flex-shrink:0}
.t-ok{background:rgba(0,240,160,.18);border:1px solid rgba(0,240,160,.25);color:var(--mint)}
.t-err{background:rgba(255,59,92,.18);border:1px solid rgba(255,59,92,.25);color:var(--red)}
.t-info{background:rgba(56,182,255,.18);border:1px solid rgba(56,182,255,.25);color:var(--sky)}
.t-warn{background:rgba(255,184,48,.18);border:1px solid rgba(255,184,48,.25);color:var(--amber)}
@keyframes tIn{to{transform:translateY(0);opacity:1}}
@keyframes tOut{to{transform:translateY(-12px) scale(.96);opacity:0}}

/* ====== HEADER ====== */
.hdr{
    background:linear-gradient(170deg,#0e0e22 0%,#08081a 100%);
    padding:max(env(safe-area-inset-top),12px) 16px 0;
    flex-shrink:0;
    position:relative;
    border-bottom:1px solid var(--border);
}
.hdr::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--mint-glow),transparent)}

.hdr-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.brand{display:flex;align-items:center;gap:10px}
.brand-logo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--mint),#00c080);display:flex;align-items:center;justify-content:center;font-size:15px;color:#000;font-weight:900;box-shadow:0 4px 18px rgba(0,240,160,.3)}
.brand-name{font-size:17px;font-weight:800;letter-spacing:-.3px}
.brand-tag{font-size:9px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:1.5px}

.hdr-btns{display:flex;gap:6px}
.ib{width:34px;height:34px;border-radius:50%;background:var(--bg-2);border:1px solid var(--border);color:var(--text-2);display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;transition:.15s}
.ib:active{transform:scale(.88);background:var(--bg-3)}

/* Account Chip */
.acc-chip{display:flex;align-items:center;gap:8px;padding:5px 12px 5px 8px;background:var(--bg-2);border:1px solid var(--border-l);border-radius:100px;font-size:12px;font-weight:600;cursor:pointer;margin-bottom:10px;transition:.15s;position:relative}
.acc-chip:active{background:var(--bg-3)}
.acc-dot{width:8px;height:8px;border-radius:50%}
.acc-dot.real{background:var(--mint)}
.acc-dot.demo{background:var(--violet)}
.acc-badge{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.acc-badge.real{background:var(--mint-dim);color:var(--mint)}
.acc-badge.demo{background:var(--violet-dim);color:var(--violet)}

/* Balance */
.bal-sec{text-align:center;padding:4px 0 14px}
.bal-lbl{font-size:10px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:2px}
.bal-amt{font-family:'JetBrains Mono',monospace;font-size:38px;font-weight:800;letter-spacing:-2px;transition:.3s}
.bal-amt.flash-g{animation:fG .5s}
.bal-amt.flash-r{animation:fR .5s}
@keyframes fG{0%,100%{color:var(--text-0)}50%{color:var(--mint)}}
@keyframes fR{0%,100%{color:var(--text-0)}50%{color:var(--red)}}

.chips{display:flex;justify-content:center;gap:6px;margin-top:8px;flex-wrap:wrap}
.chip{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:100px;font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
.chip i{font-size:8px}
.c-prot{background:var(--mint-dim);color:var(--mint)}
.c-act{background:var(--sky-dim);color:var(--sky)}
.c-wr{background:var(--violet-dim);color:var(--violet)}
.c-pnl{background:var(--amber-dim);color:var(--amber)}

/* ====== SCROLL CONTENT ====== */
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:76px}
.scroll::-webkit-scrollbar{display:none}
.pg{display:none;padding:14px 16px}
.pg.on{display:block;animation:pgIn .2s ease}
@keyframes pgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ====== CARDS & COMPONENTS ====== */
.card{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;margin-bottom:10px}
.card-g{border-color:rgba(0,240,160,.1);box-shadow:0 0 30px rgba(0,240,160,.03)}

.slbl{font-size:10px;color:var(--text-3);font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}

/* Quick Stats Grid */
.qsg{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.qs{background:var(--bg-2);border-radius:var(--r-md);padding:14px;border:1px solid var(--border)}
.qs-l{font-size:10px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
.qs-v{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:800}
.qs-v.g{color:var(--mint)}.qs-v.r{color:var(--red)}.qs-v.b{color:var(--sky)}.qs-v.a{color:var(--amber)}.qs-v.v{color:var(--violet)}

/* Session Card */
.ses-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.ses-row:last-child{border:none}
.ses-rl{color:var(--text-2)}
.ses-rv{font-weight:600;font-family:'JetBrains Mono',monospace;font-size:12px}

.ses-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:100px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.sb-on{background:var(--mint-dim);color:var(--mint)}
.sb-off{background:var(--bg-3);color:var(--text-3)}
.sb-stop{background:var(--red-dim);color:var(--red)}

/* ====== TRADE PAGE ====== */
.t-hero{text-align:center;padding:20px 16px;background:linear-gradient(160deg,var(--bg-2),var(--bg-1));border-radius:var(--r-lg);border:1px solid var(--border-l);margin-bottom:14px;position:relative;overflow:hidden}
.t-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 30%,rgba(56,182,255,.06),transparent 60%);pointer-events:none}
.t-tag{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:100px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;background:var(--sky-dim);color:var(--sky);margin-bottom:6px}
.t-amt{font-family:'JetBrains Mono',monospace;font-size:48px;font-weight:800;letter-spacing:-3px}
.t-sub{font-size:12px;color:var(--text-3);margin-top:2px}

.t-prog{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg-2);border-radius:var(--r-md);margin-bottom:14px}
.t-prog-bar{flex:1;height:5px;background:var(--bg-4);border-radius:100px;overflow:hidden}
.t-prog-fill{height:100%;background:linear-gradient(90deg,var(--mint),var(--sky));border-radius:100px;transition:width .4s cubic-bezier(.4,0,.2,1)}
.t-prog-txt{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--text-2);white-space:nowrap}

.t-banner{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--r-md);font-size:12px;font-weight:600;margin-bottom:12px}
.b-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.ban-ok{background:var(--mint-dim);color:var(--mint);border:1px solid rgba(0,240,160,.15)}
.ban-ok .b-dot{background:var(--mint);animation:pulse 2s infinite}
.ban-w{background:var(--amber-dim);color:var(--amber);border:1px solid rgba(255,184,48,.15)}
.ban-w .b-dot{background:var(--amber)}
.ban-s{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,59,92,.15)}
.ban-s .b-dot{background:var(--red)}
.ban-d{background:var(--sky-dim);color:var(--sky);border:1px solid rgba(56,182,255,.15)}
.ban-d .b-dot{background:var(--sky)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

.t-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tb{padding:20px 14px;border-radius:var(--r-lg);border:none;font-family:'Outfit',sans-serif;font-size:15px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;transition:.12s;position:relative;overflow:hidden}
.tb i{font-size:30px}
.tb:active{transform:scale(.94)}
.tb-w{background:linear-gradient(160deg,#00F0A0,#00c080);color:#000;box-shadow:0 6px 22px rgba(0,240,160,.22)}
.tb-l{background:linear-gradient(160deg,#FF3B5C,#d02040);color:#fff;box-shadow:0 6px 22px rgba(255,59,92,.22)}
.tb:disabled{opacity:.2;cursor:not-allowed;transform:none!important;box-shadow:none}

/* ====== HISTORY ====== */
.hi{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.hi:last-child{border:none}
.hi-ico{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.hi-ico.w{background:var(--mint-dim);color:var(--mint)}
.hi-ico.l{background:var(--red-dim);color:var(--red)}
.hi-body{flex:1;min-width:0}
.hi-t{font-size:14px;font-weight:600}
.hi-s{font-size:11px;color:var(--text-3)}
.hi-a{text-align:right;font-family:'JetBrains Mono',monospace;font-weight:700;font-size:14px}
.hi-a.w{color:var(--mint)}.hi-a.l{color:var(--red)}

.empty{text-align:center;padding:40px 20px;color:var(--text-3)}
.empty i{font-size:40px;opacity:.25;margin-bottom:10px;display:block}
.empty p{font-size:14px}

/* ====== CHARTS ====== */
.chart-wrap{position:relative;height:220px;width:100%;margin-bottom:12px}
.chart-nav{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.chart-nav::-webkit-scrollbar{display:none}
.cn-btn{padding:6px 12px;background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r-sm);cursor:pointer;font-size:11px;font-weight:600;color:var(--text-2);white-space:nowrap;font-family:'Outfit',sans-serif;transition:.15s}
.cn-btn.on{background:var(--sky);color:#000;border-color:var(--sky)}
.cn-btn:active{transform:scale(.94)}

/* ====== BUTTONS ====== */
.btn{width:100%;padding:14px;border-radius:var(--r-md);border:none;font-family:'Outfit',sans-serif;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:.12s}
.btn:active{transform:scale(.97)}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important}
.btn-p{background:var(--sky);color:#000}.btn-m{background:var(--mint);color:#000}
.btn-r{background:var(--red);color:#fff}.btn-g{background:var(--bg-3);color:var(--text-1)}
.btn-v{background:var(--violet);color:#fff}
.btn-amb{background:var(--amber);color:#000}

/* ====== SETTINGS INPUTS ====== */
.sg{margin-bottom:16px}
.sg-l{font-size:12px;color:var(--text-2);font-weight:600;margin-bottom:6px}
.sg-i{width:100%;padding:12px 14px;border-radius:var(--r-md);border:1px solid var(--border-l);background:var(--bg-2);color:var(--text-0);font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600;outline:none;transition:.2s}
.sg-i:focus{border-color:var(--sky);box-shadow:0 0 0 3px var(--sky-dim)}
.sg-h{font-size:11px;color:var(--text-3);margin-top:4px}

.divider{height:1px;background:var(--border);margin:16px 0}

.dz{background:var(--red-dim);border:1px solid rgba(255,59,92,.15);border-radius:var(--r-lg);padding:16px}
.dz-t{font-size:13px;font-weight:700;color:var(--red);margin-bottom:10px}

.da-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}

/* ====== BOTTOM SHEETS ====== */
.bk{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:6000;display:none;opacity:0;transition:opacity .25s}
.bk.on{display:block;opacity:1}

.bs{position:fixed;bottom:0;left:0;right:0;max-width:430px;margin:0 auto;background:var(--bg-1);border-radius:var(--r-xl) var(--r-xl) 0 0;z-index:6001;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);max-height:88vh;display:flex;flex-direction:column;box-shadow:0 -8px 40px rgba(0,0,0,.5)}
.bs.on{transform:translateY(0)}
.bs-handle{width:36px;height:4px;border-radius:100px;background:var(--bg-4);margin:8px auto;flex-shrink:0}
.bs-hdr{display:flex;align-items:center;justify-content:space-between;padding:2px 18px 14px;flex-shrink:0}
.bs-title{font-size:18px;font-weight:800}
.bs-x{width:30px;height:30px;border-radius:50%;background:var(--bg-3);border:none;color:var(--text-2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px}
.bs-x:active{transform:scale(.88)}
.bs-body{padding:0 18px 28px;overflow-y:auto;-webkit-overflow-scrolling:touch;flex:1}

/* Win Sheet */
.wbd{text-align:center;padding:16px;background:var(--bg-2);border-radius:var(--r-lg);margin-bottom:16px;border:1px solid var(--border)}
.wbd-l{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.wbd-a{font-family:'JetBrains Mono',monospace;font-size:32px;font-weight:800;color:var(--sky)}

.pp{background:var(--mint-dim);border:1px solid rgba(0,240,160,.15);border-radius:var(--r-md);padding:14px;margin:12px 0;text-align:center;display:none}
.pp-l{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:1px}
.pp-v{font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:800;color:var(--mint)}
.pp-b{font-size:11px;color:var(--text-2);margin-top:2px}

/* Loss Sheet */
.lcb{background:var(--red-dim);border:1px solid rgba(255,59,92,.2);border-radius:var(--r-lg);padding:20px;text-align:center;margin-bottom:16px}
.lcb-ico{font-size:36px;color:var(--red);margin-bottom:6px}
.lcb-t{font-size:16px;font-weight:700;color:var(--red);margin-bottom:2px}
.lcb-a{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:800;color:var(--red);margin-bottom:2px}
.lcb-s{font-size:12px;color:var(--text-3)}

.lb-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}

/* Result Overlay */
.rov{position:fixed;inset:0;z-index:7000;display:none;align-items:center;justify-content:center;padding:20px;background:rgba(0,0,0,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.rov.on{display:flex;animation:fadeIn .25s}
.rc{background:var(--bg-1);border-radius:var(--r-xl);padding:28px 22px 22px;width:100%;max-width:370px;text-align:center;animation:rcPop .35s cubic-bezier(.34,1.56,.64,1);border:1px solid var(--border-l)}
@keyframes rcPop{from{transform:scale(.85);opacity:0}to{transform:scale(1);opacity:1}}
.rc-emoji{font-size:50px;margin-bottom:8px}
.rc-title{font-size:20px;font-weight:800;margin-bottom:2px}
.rc-sub{font-size:13px;color:var(--text-3);margin-bottom:16px}
.rc-rows{background:var(--bg-2);border-radius:var(--r-md);overflow:hidden;margin-bottom:16px}
.rc-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;font-size:13px;border-bottom:1px solid var(--border)}
.rc-row:last-child{border:none}
.rc-rl{color:var(--text-2)}
.rc-rv{font-family:'JetBrains Mono',monospace;font-weight:700}

/* Account Dropdown Sheet */
.acc-list-item{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:var(--r-md);cursor:pointer;transition:.12s;border:1px solid transparent;margin-bottom:6px}
.acc-list-item:active{background:var(--bg-3)}
.acc-list-item.active{border-color:var(--mint);background:var(--mint-dim)}
.ali-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.ali-body{flex:1;min-width:0}
.ali-name{font-size:14px;font-weight:600}
.ali-bal{font-size:12px;color:var(--text-3);font-family:'JetBrains Mono',monospace}
.ali-type{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;text-transform:uppercase}

/* ====== TAB BAR ====== */
.tbar{position:fixed;bottom:0;left:0;right:0;max-width:430px;margin:0 auto;background:rgba(12,12,24,.96);backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);display:flex;padding:4px 6px max(env(safe-area-inset-bottom),6px);border-top:1px solid var(--border);z-index:100}
.ttab{flex:1;display:flex;flex-direction:column;align-items:center;gap:1px;padding:7px 2px;color:var(--text-3);font-size:9px;font-weight:600;cursor:pointer;border-radius:var(--r-sm);transition:.15s;border:none;background:none;font-family:'Outfit',sans-serif}
.ttab i{font-size:20px;transition:.15s}
.ttab.on{color:var(--mint)}
.ttab.on i{transform:scale(1.08)}
.ttab:active{transform:scale(.88)}

/* Info Box */
.ibox{background:var(--sky-dim);border:1px solid rgba(56,182,255,.15);border-radius:var(--r-md);padding:14px;font-size:12px;line-height:1.7;color:var(--text-1)}
.ibox strong{color:var(--sky)}

/* Quote */
.qcard{background:linear-gradient(140deg,var(--bg-2),var(--bg-1));border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;position:relative;overflow:hidden}
.qcard::before{content:'"';position:absolute;top:-8px;left:10px;font-size:70px;color:var(--mint);opacity:.08;font-family:Georgia,serif;line-height:1}
.qcard p{font-size:13px;font-style:italic;color:var(--text-2);line-height:1.7;position:relative;z-index:1}

/* Account Type Selector */
.ats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.at{padding:14px;border:2px solid var(--border-l);border-radius:var(--r-md);cursor:pointer;text-align:center;transition:.15s}
.at:active{transform:scale(.96)}
.at.sel{border-color:var(--mint);background:var(--mint-dim)}
.at i{font-size:20px;display:block;margin-bottom:4px}
.at span{font-size:13px;font-weight:700}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}

@media(max-width:380px){
    .bal-amt{font-size:32px}
    .t-amt{font-size:40px}
}
    </style>
</head>
<body>
<div class="app">
    <div class="toast-box" id="toastBox"></div>

    <!-- HEADER -->
    <div class="hdr">
        <div class="hdr-top">
            <div class="brand">
                <div class="brand-logo"><i class="fas fa-bolt"></i></div>
                <div><div class="brand-name">TradeVault</div><div class="brand-tag">Pro Trading System</div></div>
            </div>
            <div class="hdr-btns">
                <button class="ib" id="btnAccSheet" title="Cuentas"><i class="fas fa-wallet"></i></button>
                <button class="ib" id="btnNewSes" title="Nueva Sesi√≥n"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <div class="acc-chip" id="accChip">
            <span class="acc-dot real" id="accDot"></span>
            <span id="accName">Sin cuenta</span>
            <span class="acc-badge real" id="accBadge">‚Äî</span>
            <i class="fas fa-chevron-down" style="font-size:10px;color:var(--text-3);margin-left:auto"></i>
        </div>
        <div class="bal-sec">
            <div class="bal-lbl">Balance Total</div>
            <div class="bal-amt mono" id="balAmt">$0.00</div>
            <div class="chips">
                <div class="chip c-prot"><i class="fas fa-shield-halved"></i> <span id="cProt">$0</span></div>
                <div class="chip c-act"><i class="fas fa-arrow-trend-up"></i> <span id="cAct">$0</span></div>
                <div class="chip c-wr"><i class="fas fa-percent"></i> <span id="cWr">0%</span></div>
                <div class="chip c-pnl"><i class="fas fa-chart-line"></i> <span id="cPnl">$0</span></div>
            </div>
        </div>
    </div>

    <!-- SCROLL -->
    <div class="scroll">
        <!-- DASHBOARD -->
        <div class="pg on" id="pgDash">
            <div class="slbl">Estad√≠sticas</div>
            <div class="qsg">
                <div class="qs"><div class="qs-l">Wins</div><div class="qs-v g" id="sW">0</div></div>
                <div class="qs"><div class="qs-l">Losses</div><div class="qs-v r" id="sL">0</div></div>
                <div class="qs"><div class="qs-l">Trades Hoy</div><div class="qs-v a" id="sT">0/10</div></div>
                <div class="qs"><div class="qs-l">Siguiente</div><div class="qs-v b" id="sN">$1</div></div>
            </div>
            <div style="height:12px"></div>
            <div class="slbl">Sesi√≥n RevInc</div>
            <div class="card">
                <div style="margin-bottom:8px"><span class="ses-badge sb-off" id="sesBadge"><i class="fas fa-circle" style="font-size:5px"></i> SIN INICIAR</span></div>
                <div class="ses-row"><span class="ses-rl">Sesi√≥n</span><span class="ses-rv" id="sesN">#1</span></div>
                <div class="ses-row"><span class="ses-rl">Trades</span><span class="ses-rv" id="sesTr">0</span></div>
                <div class="ses-row"><span class="ses-rl">Entrada base</span><span class="ses-rv" id="sesB">$1</span></div>
                <div class="ses-row"><span class="ses-rl">P&L Total</span><span class="ses-rv" id="sesPnl">$0.00</span></div>
            </div>
            <div style="height:8px"></div>
            <div class="slbl">Hoy</div>
            <div class="card">
                <div class="ses-row"><span class="ses-rl">Trades hoy</span><span class="ses-rv" id="dayTr">0</span></div>
                <div class="ses-row"><span class="ses-rl">P&L hoy</span><span class="ses-rv" id="dayPnl">$0.00</span></div>
                <div class="ses-row"><span class="ses-rl">Meta diaria</span><span class="ses-rv" id="dayGoal">‚Äî</span></div>
            </div>
            <div style="height:8px"></div>
            <div class="qcard"><p>RevInc no busca ganar siempre. Busca que las p√©rdidas no destruyan la cuenta y que las ganancias no se devuelvan.</p></div>
        </div>

        <!-- TRADE -->
        <div class="pg" id="pgTrade">
            <div id="tBanner" class="t-banner ban-w"><div class="b-dot"></div><span>Configura para comenzar</span></div>
            <div class="t-hero">
                <div class="t-tag"><i class="fas fa-crosshairs"></i> ENTRADA ACTUAL</div>
                <div class="t-amt mono" id="tAmt">$0</div>
                <div class="t-sub" id="tSub">Configura para empezar</div>
            </div>
            <div class="t-prog"><div class="t-prog-bar"><div class="t-prog-fill" id="tFill" style="width:0%"></div></div><div class="t-prog-txt mono" id="tProg">0/10</div></div>
            <div class="t-btns">
                <button class="tb tb-w" id="btnW" disabled><i class="fas fa-check-circle"></i><span>WIN</span></button>
                <button class="tb tb-l" id="btnL" disabled><i class="fas fa-times-circle"></i><span>LOSS</span></button>
            </div>
            <div style="height:14px"></div>
            <div class="ibox"><strong>60/40 RevInc:</strong> Al ganar, 60% va a Capital Protegido, 40% a Capital Activo. Al perder, el capital activo se reinicia a $0 y vuelves a la entrada base.</div>
        </div>

        <!-- HISTORY -->
        <div class="pg" id="pgHist">
            <div class="slbl">√öltimas Operaciones</div>
            <div id="histEmpty" class="empty"><i class="fas fa-clock-rotate-left"></i><p>Sin operaciones a√∫n</p></div>
            <div id="histList" class="card" style="display:none;padding:2px 14px"></div>
        </div>

        <!-- CHARTS -->
        <div class="pg" id="pgCharts">
            <div class="slbl">Balance del Mes</div>
            <div class="card">
                <div class="chart-wrap"><canvas id="chartBalance"></canvas></div>
                <div class="chart-nav" id="monthNav"></div>
            </div>
            <div style="height:8px"></div>
            <div class="slbl">P&L Diario</div>
            <div class="card">
                <div class="chart-wrap"><canvas id="chartDaily"></canvas></div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div class="pg" id="pgSet">
            <div class="slbl">Configuraci√≥n de Cuenta</div>
            <div class="card">
                <div class="sg"><div class="sg-l">Saldo de la Cuenta</div><input type="number" class="sg-i" id="cfgBal" placeholder="100" min="0.01" step="0.01"><div class="sg-h">Tu saldo real en el broker</div></div>
                <div class="sg"><div class="sg-l">Entrada Base</div><input type="number" class="sg-i" id="cfgBase" placeholder="1" min="0.01" step="0.01" value="1"></div>
                <div class="sg"><div class="sg-l">Max Trades por Sesi√≥n</div><input type="number" class="sg-i" id="cfgMax" placeholder="10" min="1" value="10"></div>
                <div class="sg"><div class="sg-l">Meta Diaria ($)</div><input type="number" class="sg-i" id="cfgGoal" placeholder="0" min="0" step="0.01" value="0"><div class="sg-h">Opcional ‚Äî 0 para desactivar</div></div>
                <button class="btn btn-p" id="btnSaveCfg"><i class="fas fa-check"></i> Guardar</button>
            </div>
            <div style="height:10px"></div>
            <div class="slbl">Datos</div>
            <div class="card">
                <div class="da-grid">
                    <button class="btn btn-g" id="btnExp"><i class="fas fa-arrow-up-from-bracket"></i> Exportar</button>
                    <button class="btn btn-g" id="btnImp"><i class="fas fa-arrow-down-to-bracket"></i> Importar</button>
                </div>
                <div class="ses-row"><span class="ses-rl">Trades totales</span><span class="ses-rv" id="dTot">0</span></div>
                <div class="ses-row"><span class="ses-rl">Sesiones</span><span class="ses-rv" id="dSes">0</span></div>
            </div>
            <div style="height:10px"></div>
            <div class="slbl">Zona de Peligro</div>
            <div class="dz">
                <div class="dz-t"><i class="fas fa-triangle-exclamation"></i> Irreversible</div>
                <button class="btn btn-r" id="btnDelAcc" style="margin-bottom:8px"><i class="fas fa-trash"></i> Eliminar Cuenta Actual</button>
                <button class="btn btn-g" id="btnResetAcc"><i class="fas fa-rotate-left"></i> Reiniciar Cuenta</button>
            </div>
        </div>
    </div>

    <!-- TAB BAR -->
    <div class="tbar">
        <button class="ttab on" data-pg="pgDash"><i class="fas fa-chart-pie"></i><span>Inicio</span></button>
        <button class="ttab" data-pg="pgTrade"><i class="fas fa-bolt"></i><span>Operar</span></button>
        <button class="ttab" data-pg="pgHist"><i class="fas fa-clock-rotate-left"></i><span>Historial</span></button>
        <button class="ttab" data-pg="pgCharts"><i class="fas fa-chart-area"></i><span>Gr√°ficos</span></button>
        <button class="ttab" data-pg="pgSet"><i class="fas fa-gear"></i><span>Ajustes</span></button>
    </div>

    <!-- RESULT OVERLAY -->
    <div class="rov" id="rov"><div class="rc" id="rc"></div></div>

    <!-- BACKDROP -->
    <div class="bk" id="bk"></div>

    <!-- WIN SHEET -->
    <div class="bs" id="shWin">
        <div class="bs-handle"></div>
        <div class="bs-hdr"><div class="bs-title">Registrar WIN</div><button class="bs-x" id="xWin"><i class="fas fa-xmark"></i></button></div>
        <div class="bs-body">
            <div class="wbd"><div class="wbd-l">Apostaste</div><div class="wbd-a mono" id="wBet">$0</div></div>
            <div class="sg"><div class="sg-l">Monto Total Recibido del Broker</div><input type="number" class="sg-i" id="wRcv" placeholder="1.96" min="0.01" step="0.01"><div class="sg-h">Tu apuesta + ganancia</div></div>
            <div class="pp" id="pp"><div class="pp-l">Ganancia Neta</div><div class="pp-v mono" id="ppV">$0</div><div class="pp-b" id="ppB">Prot: $0 ¬∑ Act: $0</div></div>
            <button class="btn btn-m" id="btnCW" disabled><i class="fas fa-check-circle"></i> Confirmar WIN</button>
        </div>
    </div>

    <!-- LOSS SHEET -->
    <div class="bs" id="shLoss">
        <div class="bs-handle"></div>
        <div class="bs-hdr"><div class="bs-title">Confirmar LOSS</div><button class="bs-x" id="xLoss"><i class="fas fa-xmark"></i></button></div>
        <div class="bs-body">
            <div class="lcb"><div class="lcb-ico"><i class="fas fa-arrow-down"></i></div><div class="lcb-t">P√©rdida</div><div class="lcb-a mono" id="lAmt">$0</div><div class="lcb-s">Capital activo se reinicia a $0</div></div>
            <div class="lb-grid">
                <button class="btn btn-g" id="lCancel"><i class="fas fa-xmark"></i> Cancelar</button>
                <button class="btn btn-r" id="lConfirm"><i class="fas fa-check"></i> Confirmar</button>
            </div>
        </div>
    </div>

    <!-- NEW SESSION SHEET -->
    <div class="bs" id="shSes">
        <div class="bs-handle"></div>
        <div class="bs-hdr"><div class="bs-title">Nueva Sesi√≥n</div><button class="bs-x" id="xSes"><i class="fas fa-xmark"></i></button></div>
        <div class="bs-body">
            <div class="ibox" style="margin-bottom:14px">Mantiene tus datos hist√≥ricos. Reinicia el contador de trades.</div>
            <div class="sg"><div class="sg-l">Entrada Base</div><input type="number" class="sg-i" id="nsBase" placeholder="1" min="0.01" step="0.01" value="1"></div>
            <div class="sg"><div class="sg-l">Max Trades</div><input type="number" class="sg-i" id="nsMax" placeholder="10" min="1" value="10"></div>
            <button class="btn btn-v" id="btnSS"><i class="fas fa-play"></i> Iniciar Sesi√≥n</button>
        </div>
    </div>

    <!-- ACCOUNTS SHEET -->
    <div class="bs" id="shAcc">
        <div class="bs-handle"></div>
        <div class="bs-hdr"><div class="bs-title">Mis Cuentas</div><button class="bs-x" id="xAcc"><i class="fas fa-xmark"></i></button></div>
        <div class="bs-body">
            <div id="accListBody"></div>
            <div style="height:12px"></div>
            <button class="btn btn-p" id="btnNewAcc"><i class="fas fa-plus"></i> Nueva Cuenta</button>
        </div>
    </div>

    <!-- NEW ACCOUNT SHEET -->
    <div class="bs" id="shNewAcc">
        <div class="bs-handle"></div>
        <div class="bs-hdr"><div class="bs-title">Nueva Cuenta</div><button class="bs-x" id="xNewAcc"><i class="fas fa-xmark"></i></button></div>
        <div class="bs-body">
            <div class="ats">
                <div class="at sel" data-t="real" id="atReal"><i class="fas fa-coins"></i><span>Real</span></div>
                <div class="at" data-t="demo" id="atDemo"><i class="fas fa-flask"></i><span>Demo</span></div>
            </div>
            <div class="sg"><div class="sg-l">Nombre</div><input type="text" class="sg-i" id="naName" placeholder="Mi Cuenta" style="font-family:'Outfit',sans-serif"></div>
            <div class="sg"><div class="sg-l">Saldo Inicial</div><input type="number" class="sg-i" id="naBal" placeholder="100" min="0.01" step="0.01"></div>
            <div class="sg"><div class="sg-l">Entrada Base</div><input type="number" class="sg-i" id="naBase" placeholder="1" min="0.01" step="0.01" value="1"></div>
            <button class="btn btn-m" id="btnCreateAcc"><i class="fas fa-check"></i> Crear Cuenta</button>
        </div>
    </div>
</div>

<input type="file" id="fileIn" accept=".json" style="display:none">

<script>
(()=>{
'use strict';

// ====== APP STATE ======
const APP={
    accounts:{},
    currentId:null,
    version:'3.0',
    db:null
};

const DB='TradeVaultPro_DB';const VER=1;const ST='data';

// ====== DOM ======
const $=id=>document.getElementById(id);
const $$=s=>document.querySelectorAll(s);

// ====== INDEXEDDB ======
async function openDB(){
    return new Promise((res,rej)=>{
        const r=indexedDB.open(DB,VER);
        r.onerror=()=>rej(r.error);
        r.onsuccess=()=>{APP.db=r.result;res()};
        r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains(ST))d.createObjectStore(ST,{keyPath:'key'})};
    });
}
async function dbGet(){
    return new Promise(res=>{
        const tx=APP.db.transaction([ST],'readonly');
        const req=tx.objectStore(ST).get('app');
        req.onsuccess=()=>res(req.result?.value||null);
        req.onerror=()=>res(null);
    });
}
async function dbSave(){
    const d={accounts:APP.accounts,currentId:APP.currentId,version:APP.version};
    return new Promise(res=>{
        const tx=APP.db.transaction([ST],'readwrite');
        tx.objectStore(ST).put({key:'app',value:d});
        tx.oncomplete=()=>res();
    });
}

// ====== HELPERS ======
function toast(msg,type='info'){
    const ic={ok:'check-circle',err:'circle-xmark',info:'circle-info',warn:'triangle-exclamation'};
    const cls={ok:'t-ok',err:'t-err',info:'t-info',warn:'t-warn'};
    const t=document.createElement('div');
    t.className=`toast ${cls[type]||'t-info'}`;
    t.innerHTML=`<i class="fas fa-${ic[type]||'circle-info'}"></i><span>${msg}</span>`;
    $('toastBox').appendChild(t);
    setTimeout(()=>{t.classList.add('out');setTimeout(()=>t.remove(),250)},2600);
}
function fmt(n,d=2){return(+n).toFixed(d)}
function fDate(d){if(!d)return'‚Äî';const dt=new Date(d);return dt.toLocaleDateString('es',{day:'2-digit',month:'short'})+' '+dt.toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})}
function today(){return new Date().toLocaleDateString('es-ES')}

// ====== ACCOUNT HELPERS ======
function acc(){return APP.currentId?APP.accounts[APP.currentId]:null}
function calcEntry(a){
    let s=Math.floor(a.baseEntry+a.active);
    if(s<a.baseEntry)s=a.baseEntry;
    if(s>a.balance)s=a.baseEntry;
    return s;
}
function canTrade(){const a=acc();return a&&a.ready&&a.tradesCount<a.maxTrades&&a.balance>=a.baseEntry}

// ====== DEFAULT ACCOUNT ======
function newAccObj(name,type,balance,baseEntry){
    return{
        id:'acc_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
        name,type,
        initialBalance:balance,
        balance,
        protected:0,active:0,
        baseEntry:baseEntry||1,currentEntry:baseEntry||1,
        maxTrades:10,tradesCount:0,
        wins:0,losses:0,
        history:[],
        protRate:0.60,
        session:1,sessionStart:null,lastTrade:null,
        ready:false,
        dailyGoal:0,
        tradingDays:[]
    };
}

// ====== RENDER ======
function render(){
    const a=acc();
    if(!a){
        $('balAmt').textContent='$0.00';
        $('accName').textContent='Sin cuenta';
        $('accBadge').textContent='‚Äî';
        return;
    }

    // Header
    $('accName').textContent=a.name;
    $('accBadge').textContent=a.type==='real'?'REAL':'DEMO';
    $('accBadge').className=`acc-badge ${a.type}`;
    $('accDot').className=`acc-dot ${a.type}`;
    $('balAmt').textContent=`$${fmt(a.balance)}`;
    $('cProt').textContent=`$${fmt(a.protected,0)}`;
    $('cAct').textContent=`$${fmt(a.active,0)}`;
    const tot=a.wins+a.losses;
    const wr=tot>0?Math.round(a.wins/tot*100):0;
    $('cWr').textContent=`${wr}%`;
    const pnl=+(a.balance-a.initialBalance).toFixed(2);
    $('cPnl').textContent=`${pnl>=0?'+':''}$${fmt(pnl)}`;

    // Dashboard
    $('sW').textContent=a.wins;
    $('sL').textContent=a.losses;
    $('sT').textContent=`${a.tradesCount}/${a.maxTrades}`;
    const sug=calcEntry(a);
    $('sN').textContent=`$${sug}`;

    $('sesN').textContent=`#${a.session}`;
    $('sesTr').textContent=a.tradesCount;
    $('sesB').textContent=`$${a.baseEntry}`;
    $('sesPnl').textContent=`${pnl>=0?'+':''}$${fmt(pnl)}`;
    $('sesPnl').style.color=pnl>=0?'var(--mint)':'var(--red)';

    // Session badge
    if(a.ready){
        if(a.balance<a.baseEntry){$('sesBadge').className='ses-badge sb-stop';$('sesBadge').innerHTML='<i class="fas fa-circle" style="font-size:5px"></i> DETENIDA'}
        else if(a.tradesCount>=a.maxTrades){$('sesBadge').className='ses-badge sb-stop';$('sesBadge').innerHTML='<i class="fas fa-circle" style="font-size:5px"></i> COMPLETADA'}
        else{$('sesBadge').className='ses-badge sb-on';$('sesBadge').innerHTML='<i class="fas fa-circle" style="font-size:5px"></i> ACTIVA'}
    }else{$('sesBadge').className='ses-badge sb-off';$('sesBadge').innerHTML='<i class="fas fa-circle" style="font-size:5px"></i> SIN INICIAR'}

    // Daily
    const td=today();
    const todayTrades=a.history.filter(t=>t.date===td);
    $('dayTr').textContent=todayTrades.length;
    const dayPnl=todayTrades.reduce((s,t)=>s+t.pnl,0);
    $('dayPnl').textContent=`${dayPnl>=0?'+':''}$${fmt(dayPnl)}`;
    $('dayPnl').style.color=dayPnl>=0?'var(--mint)':'var(--red)';
    $('dayGoal').textContent=a.dailyGoal>0?`$${fmt(a.dailyGoal)}`:'‚Äî';

    // Trade page
    a.currentEntry=sug;
    $('tAmt').textContent=`$${a.currentEntry}`;
    const pct=a.maxTrades>0?(a.tradesCount/a.maxTrades*100):0;
    $('tFill').style.width=`${pct}%`;
    $('tProg').textContent=`${a.tradesCount}/${a.maxTrades}`;

    if(!a.ready){
        $('tBanner').className='t-banner ban-w';$('tBanner').innerHTML='<div class="b-dot"></div><span>Configura para comenzar</span>';
        $('tSub').textContent='Ve a Ajustes';$('btnW').disabled=true;$('btnL').disabled=true;
    }else if(a.balance<a.baseEntry){
        $('tBanner').className='t-banner ban-s';$('tBanner').innerHTML='<div class="b-dot"></div><span>Saldo insuficiente</span>';
        $('tSub').textContent='Necesitas m√°s fondos';$('btnW').disabled=true;$('btnL').disabled=true;
    }else if(a.tradesCount>=a.maxTrades){
        $('tBanner').className='t-banner ban-d';$('tBanner').innerHTML='<div class="b-dot"></div><span>Sesi√≥n completada</span>';
        $('tSub').textContent=`${a.maxTrades} trades hechos`;$('btnW').disabled=true;$('btnL').disabled=true;
    }else{
        $('tBanner').className='t-banner ban-ok';$('tBanner').innerHTML='<div class="b-dot"></div><span>Listo para operar</span>';
        $('tSub').textContent=`Trade ${a.tradesCount+1} de ${a.maxTrades}`;$('btnW').disabled=false;$('btnL').disabled=false;
    }

    // Config
    $('cfgBal').value=a.balance||'';
    $('cfgBase').value=a.baseEntry;
    $('cfgMax').value=a.maxTrades;
    $('cfgGoal').value=a.dailyGoal||0;
    $('dTot').textContent=a.history.length;
    $('dSes').textContent=a.session;

    renderHistory();
}

function renderHistory(){
    const a=acc();
    if(!a||a.history.length===0){$('histEmpty').style.display='block';$('histList').style.display='none';return}
    $('histEmpty').style.display='none';$('histList').style.display='block';
    const items=a.history.slice(-20).reverse();
    let h='';
    items.forEach(t=>{
        const w=t.result==='WIN';
        h+=`<div class="hi"><div class="hi-ico ${w?'w':'l'}"><i class="fas fa-${w?'arrow-up':'arrow-down'}"></i></div><div class="hi-body"><div class="hi-t">Trade #${t.num} ‚Äî ${w?'Win':'Loss'}</div><div class="hi-s">$${fmt(t.entry)} ¬∑ ${t.date} ¬∑ S${t.session}</div></div><div class="hi-a ${w?'w':'l'}">${w?'+$'+fmt(t.profit):'-$'+fmt(t.entry)}</div></div>`;
    });
    $('histList').innerHTML=h;
}

// ====== CHARTS ======
let chartBal,chartDay,cMonth=new Date().getMonth(),cYear=new Date().getFullYear();

function genMonthNav(){
    const a=acc();if(!a)return;
    const months=new Set();
    a.history.forEach(t=>{const d=new Date(t.ts);months.add(`${d.getFullYear()}-${d.getMonth()}`)});
    months.add(`${cYear}-${cMonth}`);
    const mn=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const sorted=[...months].sort().reverse();
    $('monthNav').innerHTML=sorted.map(k=>{
        const[y,m]=k.split('-').map(Number);
        const isOn=m===cMonth&&y===cYear;
        return`<button class="cn-btn${isOn?' on':''}" onclick="app.switchMonth(${m},${y})">${mn[m]} ${y}</button>`;
    }).join('');
}

function updateCharts(){
    const a=acc();if(!a)return;
    const monthTrades=a.history.filter(t=>{const d=new Date(t.ts);return d.getMonth()===cMonth&&d.getFullYear()===cYear});

    // Balance chart
    const balData=[{x:'Inicio',y:a.initialBalance}];
    let rb=a.initialBalance;
    const prevTrades=a.history.filter(t=>{const d=new Date(t.ts);return(d.getFullYear()<cYear)||(d.getFullYear()===cYear&&d.getMonth()<cMonth)});
    prevTrades.forEach(t=>{rb+=t.pnl});
    if(prevTrades.length>0)balData[0].y=rb;

    const daily={};
    monthTrades.forEach(t=>{
        if(!daily[t.date])daily[t.date]={date:t.date,pnl:0};
        daily[t.date].pnl+=t.pnl;
    });
    Object.values(daily).forEach(d=>{rb+=d.pnl;balData.push({x:d.date,y:+rb.toFixed(2)})});

    const ctx1=$('chartBalance').getContext('2d');
    if(chartBal)chartBal.destroy();
    chartBal=new Chart(ctx1,{type:'line',data:{datasets:[{label:'Balance',data:balData,borderColor:'#38B6FF',backgroundColor:'rgba(56,182,255,.08)',borderWidth:2,fill:true,tension:.4,pointBackgroundColor:'#38B6FF',pointBorderColor:'#06060e',pointBorderWidth:2,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{color:'#555570',font:{size:10}},grid:{color:'rgba(255,255,255,.03)'}},y:{ticks:{color:'#555570',font:{size:10},callback:v=>'$'+v},grid:{color:'rgba(255,255,255,.03)'}}},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`$${c.parsed.y.toFixed(2)}`}}}}});

    // Daily P&L chart
    const allDaily={};
    a.history.forEach(t=>{if(!allDaily[t.date])allDaily[t.date]={pnl:0,wins:0,total:0};allDaily[t.date].pnl+=t.pnl;allDaily[t.date].total++;if(t.result==='WIN')allDaily[t.date].wins++});
    const dates=Object.keys(allDaily).sort();
    const pnls=dates.map(d=>+allDaily[d].pnl.toFixed(2));
    const wrs=dates.map(d=>allDaily[d].total>0?Math.round(allDaily[d].wins/allDaily[d].total*100):0);

    const ctx2=$('chartDaily').getContext('2d');
    if(chartDay)chartDay.destroy();
    chartDay=new Chart(ctx2,{type:'bar',data:{labels:dates,datasets:[{label:'P&L',data:pnls,backgroundColor:pnls.map(v=>v>=0?'rgba(0,240,160,.5)':'rgba(255,59,92,.5)'),borderColor:pnls.map(v=>v>=0?'#00F0A0':'#FF3B5C'),borderWidth:1,borderRadius:4,yAxisID:'y'},{label:'Win Rate %',data:wrs,type:'line',borderColor:'#B36CFF',backgroundColor:'rgba(179,108,255,.08)',borderWidth:2,tension:.4,pointRadius:3,yAxisID:'y1'}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{color:'#555570',font:{size:9}},grid:{color:'rgba(255,255,255,.03)'}},y:{ticks:{color:'#555570',font:{size:10},callback:v=>'$'+v},grid:{color:'rgba(255,255,255,.03)'}},y1:{position:'right',min:0,max:100,ticks:{color:'#555570',font:{size:10},callback:v=>v+'%'},grid:{drawOnChartArea:false}}},plugins:{legend:{display:true,labels:{color:'#8888AA',font:{size:10}}}}}});
}

// ====== SHEETS ======
function openSh(id){$('bk').classList.add('on');$(id).classList.add('on')}
function closeSh(id){$('bk').classList.remove('on');$(id).classList.remove('on')}
function closeAll(){$('bk').classList.remove('on');$$('.bs').forEach(s=>s.classList.remove('on'))}

// ====== TRADE LOGIC ======
async function processWin(){
    const a=acc();if(!a)return;
    const rcv=parseFloat($('wRcv').value);
    if(!rcv||rcv<=0)return toast('Monto inv√°lido','err');
    const bet=a.currentEntry;
    const profit=rcv-bet;
    if(profit<=0)return toast(`Total debe ser > $${fmt(bet)}`,'err');

    const toP=+(profit*a.protRate).toFixed(4);
    const toA=+(profit*(1-a.protRate)).toFixed(4);

    a.protected=+(a.protected+toP).toFixed(4);
    a.active=+(a.active+toA).toFixed(4);
    a.balance=+(a.balance+profit).toFixed(4);
    a.wins++;a.tradesCount++;a.lastTrade=new Date().toISOString();

    const td=today();if(!a.tradingDays.includes(td))a.tradingDays.push(td);

    const trade={num:a.history.length+1,result:'WIN',entry:bet,received:rcv,profit,pnl:profit,toP,toA,balAfter:a.balance,protAfter:a.protected,actAfter:a.active,ts:new Date().toISOString(),date:td,time:new Date().toLocaleTimeString('es-ES'),session:a.session};
    a.history.push(trade);
    a.currentEntry=calcEntry(a);

    closeSh('shWin');await dbSave();render();updateCharts();genMonthNav();
    showResult('win',{bet,rcv,profit,toP,toA});
    $('balAmt').classList.add('flash-g');setTimeout(()=>$('balAmt').classList.remove('flash-g'),500);
}

async function processLoss(){
    const a=acc();if(!a)return;
    const lost=a.currentEntry;
    a.balance=+(a.balance-lost).toFixed(4);
    a.active=0;a.losses++;a.tradesCount++;a.lastTrade=new Date().toISOString();
    const td=today();if(!a.tradingDays.includes(td))a.tradingDays.push(td);

    const trade={num:a.history.length+1,result:'LOSS',entry:lost,received:0,profit:0,pnl:-lost,toP:0,toA:0,balAfter:a.balance,protAfter:a.protected,actAfter:a.active,ts:new Date().toISOString(),date:td,time:new Date().toLocaleTimeString('es-ES'),session:a.session};
    a.history.push(trade);
    a.currentEntry=a.baseEntry;

    closeSh('shLoss');await dbSave();render();updateCharts();genMonthNav();
    showResult('loss',{lost});
    $('balAmt').classList.add('flash-r');setTimeout(()=>$('balAmt').classList.remove('flash-r'),500);
}

function showResult(type,d){
    const o=$('rov'),c=$('rc');
    if(type==='win'){
        c.innerHTML=`<div class="rc-emoji">üèÜ</div><div class="rc-title" style="color:var(--mint)">¬°Trade Ganador!</div><div class="rc-sub">Apostaste $${fmt(d.bet)} ¬∑ Recibiste $${fmt(d.rcv)}</div><div class="rc-rows"><div class="rc-row"><span class="rc-rl">Ganancia neta</span><span class="rc-rv" style="color:var(--mint)">+$${fmt(d.profit)}</span></div><div class="rc-row"><span class="rc-rl">‚Üí Protegido 60%</span><span class="rc-rv" style="color:var(--mint)">+$${fmt(d.toP)}</span></div><div class="rc-row"><span class="rc-rl">‚Üí Activo 40%</span><span class="rc-rv" style="color:var(--sky)">+$${fmt(d.toA)}</span></div><div class="rc-row"><span class="rc-rl">Pr√≥xima entrada</span><span class="rc-rv" style="color:var(--sky)">$${acc().currentEntry}</span></div></div><button class="btn btn-m" onclick="app.closeRes()"><i class="fas fa-arrow-right"></i> Continuar</button>`;
    }else{
        c.innerHTML=`<div class="rc-emoji">üìâ</div><div class="rc-title" style="color:var(--red)">Trade Perdedor</div><div class="rc-sub">P√©rdida: $${fmt(d.lost)}</div><div class="rc-rows"><div class="rc-row"><span class="rc-rl">Capital protegido</span><span class="rc-rv" style="color:var(--mint)">$${fmt(acc().protected)}</span></div><div class="rc-row"><span class="rc-rl">Capital activo</span><span class="rc-rv">$0 (reiniciado)</span></div><div class="rc-row"><span class="rc-rl">Pr√≥xima entrada</span><span class="rc-rv" style="color:var(--sky)">$${acc().baseEntry}</span></div></div><button class="btn btn-g" onclick="app.closeRes()"><i class="fas fa-arrow-right"></i> Continuar</button>`;
    }
    o.classList.add('on');
}

// ====== CONFIG ======
async function saveCfg(){
    const a=acc();if(!a)return toast('No hay cuenta activa','err');
    const bal=parseFloat($('cfgBal').value);
    const base=parseFloat($('cfgBase').value);
    const max=parseInt($('cfgMax').value);
    const goal=parseFloat($('cfgGoal').value)||0;
    if(!bal||bal<=0)return toast('Saldo inv√°lido','err');
    if(!base||base<=0)return toast('Entrada inv√°lida','err');
    if(!max||max<=0)return toast('Max trades inv√°lido','err');

    a.balance=bal;a.baseEntry=base;a.maxTrades=max;a.dailyGoal=goal;
    if(!a.ready){a.ready=true;a.currentEntry=base;a.tradesCount=0;a.wins=0;a.losses=0;a.protected=0;a.active=0;a.history=[];a.sessionStart=new Date().toISOString();a.session=1;a.tradingDays=[];toast('¬°Sistema activado!','ok');switchPage('pgTrade')}
    else toast('Config guardada','info');
    await dbSave();render();
}

async function startSession(){
    const a=acc();if(!a)return;
    const base=parseFloat($('nsBase').value);
    const max=parseInt($('nsMax').value);
    if(!base||base<=0||!max||max<=0)return toast('Valores inv√°lidos','err');
    if(!a.ready){a.ready=true;a.balance=a.balance||100}
    a.session++;a.tradesCount=0;a.baseEntry=base;a.currentEntry=base;a.maxTrades=max;a.sessionStart=new Date().toISOString();a.lastTrade=null;
    closeSh('shSes');await dbSave();render();updateCharts();genMonthNav();switchPage('pgTrade');toast(`Sesi√≥n #${a.session}`,'ok');
}

async function createAccount(){
    const name=$('naName').value.trim();
    const bal=parseFloat($('naBal').value);
    const base=parseFloat($('naBase').value)||1;
    const type=$('atReal').classList.contains('sel')?'real':'demo';
    if(!name)return toast('Ingresa un nombre','err');
    if(!bal||bal<=0)return toast('Saldo inv√°lido','err');
    const a=newAccObj(name,type,bal,base);
    APP.accounts[a.id]=a;APP.currentId=a.id;
    closeSh('shNewAcc');closeSh('shAcc');await dbSave();render();updateCharts();genMonthNav();toast(`Cuenta "${name}" creada`,'ok');
}

async function deleteCurrentAcc(){
    const a=acc();if(!a)return;
    if(!confirm(`¬øEliminar "${a.name}"?\n\nSe perder√° todo.`))return;
    delete APP.accounts[a.id];
    const keys=Object.keys(APP.accounts);APP.currentId=keys.length>0?keys[0]:null;
    await dbSave();render();updateCharts();genMonthNav();toast('Cuenta eliminada','ok');
}

async function resetCurrentAcc(){
    const a=acc();if(!a)return;
    if(!confirm(`¬øReiniciar "${a.name}"?`))return;
    a.balance=a.initialBalance;a.protected=0;a.active=0;a.currentEntry=a.baseEntry;a.tradesCount=0;a.wins=0;a.losses=0;a.history=[];a.session=1;a.sessionStart=null;a.lastTrade=null;a.ready=false;a.tradingDays=[];
    await dbSave();render();updateCharts();genMonthNav();toast('Cuenta reiniciada','ok');
}

// ====== EXPORT/IMPORT ======
function exportData(){
    const d={version:'3.0',app:'TradeVaultPro',date:new Date().toISOString(),accounts:APP.accounts,currentId:APP.currentId};
    const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
    const u=URL.createObjectURL(b);const l=document.createElement('a');l.href=u;l.download=`TradeVault_${new Date().toISOString().slice(0,10)}.json`;l.click();URL.revokeObjectURL(u);toast('Exportado','ok');
}

function importData(e){
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=async ev=>{
        try{
            const d=JSON.parse(ev.target.result);
            // Support multiple formats
            if(d.accounts&&typeof d.accounts==='object'){
                if(!confirm(`Importar ${Object.keys(d.accounts).length} cuentas?`))return;
                // Merge accounts
                Object.keys(d.accounts).forEach(k=>{APP.accounts[k]=d.accounts[k]});
                if(d.currentId&&APP.accounts[d.currentId])APP.currentId=d.currentId;
                else{const ks=Object.keys(APP.accounts);if(ks.length)APP.currentId=ks[0]}
            }else if(d.account){
                if(!confirm(`Importar cuenta "${d.account.name}"?`))return;
                APP.accounts[d.account.id]=d.account;APP.currentId=d.account.id;
            }else if(d.state||d.system){
                // Legacy RevInc format
                const s=d.state||d.system;
                const a=newAccObj('Importada','real',s.balance||s.saldoCuenta||100,s.baseEntry||s.entradaBase||1);
                a.protected=s.protected||s.capitalProtegido||0;
                a.active=s.active||s.capitalActivo||0;
                a.wins=s.wins||s.contadorWins||0;
                a.losses=s.losses||s.contadorLoss||0;
                a.tradesCount=s.tradesCount||s.tradesRealizados||0;
                a.session=s.session||s.sessionNumber||1;
                a.ready=s.ready||s.inicializado||false;
                a.maxTrades=s.maxTrades||10;
                // Map history
                if(d.history)a.history=d.history.map((t,i)=>({num:t.num||t.numero||i+1,result:t.result||t.resultado||'WIN',entry:t.entry||t.entrada||0,received:t.received||t.totalRecibido||0,profit:t.profit||t.ganancia||0,pnl:t.pnl||(t.result==='WIN'||t.resultado==='WIN'?t.profit||t.ganancia||0:-(t.entry||t.entrada||0)),toP:t.toP||0,toA:t.toA||0,balAfter:t.balAfter||t.saldo||0,protAfter:t.protAfter||t.protegido||0,actAfter:t.actAfter||t.activo||0,ts:t.ts||t.timestamp||new Date().toISOString(),date:t.date||new Date().toLocaleDateString('es-ES'),time:t.time||'',session:t.session||1}));
                APP.accounts[a.id]=a;APP.currentId=a.id;
            }else throw new Error('Formato no reconocido');
            await dbSave();render();updateCharts();genMonthNav();toast('Importado','ok');
        }catch(err){toast('Error: '+err.message,'err')}
    };
    r.readAsText(f);$('fileIn').value='';
}

// ====== NAVIGATION ======
function switchPage(pg){
    $$('.pg').forEach(p=>p.classList.remove('on'));
    $(pg).classList.add('on');
    $$('.ttab').forEach(t=>t.classList.toggle('on',t.dataset.pg===pg));
    document.querySelector('.scroll').scrollTop=0;
    if(pg==='pgCharts')setTimeout(()=>{updateCharts();genMonthNav()},100);
}

function renderAccList(){
    let h='';
    Object.values(APP.accounts).forEach(a=>{
        const on=a.id===APP.currentId;
        const cls=on?' active':'';
        const dotC=a.type==='real'?'var(--mint)':'var(--violet)';
        const bgC=a.type==='real'?'var(--mint-dim)':'var(--violet-dim)';
        const txC=a.type==='real'?'var(--mint)':'var(--violet)';
        const lbl=a.type==='real'?'REAL':'DEMO';
        h+='<div class="acc-list-item'+cls+'" onclick="app.switchAcc(\''+a.id+'\')">'
          +'<div class="ali-dot" style="background:'+dotC+'"></div>'
          +'<div class="ali-body"><div class="ali-name">'+a.name+'</div>'
          +'<div class="ali-bal">$'+fmt(a.balance)+' &middot; '+a.history.length+' trades</div></div>'
          +'<span class="ali-type" style="background:'+bgC+';color:'+txC+'">'+lbl+'</span></div>';
    });
    if(!h)h='<div class="empty"><i class="fas fa-wallet"></i><p>No hay cuentas</p></div>';
    $('accListBody').innerHTML=h;
}

// ====== INIT ======
async function init(){
    await openDB();
    const saved=await dbGet();
    if(saved){APP.accounts=saved.accounts||{};APP.currentId=saved.currentId||null;APP.version=saved.version||'3.0'}
    if(!APP.currentId||!Object.keys(APP.accounts).length){
        // Create default account
        const a=newAccObj('Mi Cuenta','real',100,1);
        APP.accounts[a.id]=a;APP.currentId=a.id;
        await dbSave();
    }
    render();updateCharts();genMonthNav();
}

// ====== EVENTS ======
$$('.ttab').forEach(t=>t.addEventListener('click',()=>switchPage(t.dataset.pg)));

$('accChip').addEventListener('click',()=>{renderAccList();openSh('shAcc')});
$('btnAccSheet').addEventListener('click',()=>{renderAccList();openSh('shAcc')});
$('xAcc').addEventListener('click',()=>closeSh('shAcc'));
$('btnNewAcc').addEventListener('click',()=>{closeSh('shAcc');setTimeout(()=>openSh('shNewAcc'),200)});
$('xNewAcc').addEventListener('click',()=>closeSh('shNewAcc'));

$('atReal').addEventListener('click',()=>{$('atReal').classList.add('sel');$('atDemo').classList.remove('sel')});
$('atDemo').addEventListener('click',()=>{$('atDemo').classList.add('sel');$('atReal').classList.remove('sel')});
$('btnCreateAcc').addEventListener('click',createAccount);

$('btnNewSes').addEventListener('click',()=>{const a=acc();$('nsBase').value=a?a.baseEntry:1;$('nsMax').value=a?a.maxTrades:10;openSh('shSes')});
$('xSes').addEventListener('click',()=>closeSh('shSes'));
$('btnSS').addEventListener('click',startSession);

$('btnW').addEventListener('click',()=>{if(!canTrade())return;const a=acc();$('wBet').textContent=`$${fmt(a.currentEntry)}`;$('wRcv').value='';$('pp').style.display='none';$('btnCW').disabled=true;openSh('shWin')});
$('xWin').addEventListener('click',()=>closeSh('shWin'));
$('wRcv').addEventListener('input',function(){const v=parseFloat(this.value);const a=acc();if(!a)return;const p=v-a.currentEntry;if(v&&v>0&&p>0){const toP=p*a.protRate;const toA=p*(1-a.protRate);$('ppV').textContent=`+$${fmt(p)}`;$('ppB').textContent=`Prot: +$${fmt(toP)} ¬∑ Act: +$${fmt(toA)}`;$('pp').style.display='block';$('btnCW').disabled=false}else{$('pp').style.display='none';$('btnCW').disabled=true}});
$('btnCW').addEventListener('click',processWin);

$('btnL').addEventListener('click',()=>{if(!canTrade())return;const a=acc();$('lAmt').textContent=`$${fmt(a.currentEntry)}`;openSh('shLoss')});
$('xLoss').addEventListener('click',()=>closeSh('shLoss'));
$('lCancel').addEventListener('click',()=>closeSh('shLoss'));
$('lConfirm').addEventListener('click',processLoss);

$('bk').addEventListener('click',closeAll);

$('btnSaveCfg').addEventListener('click',saveCfg);
$('btnExp').addEventListener('click',exportData);
$('btnImp').addEventListener('click',()=>$('fileIn').click());
$('fileIn').addEventListener('change',importData);
$('btnDelAcc').addEventListener('click',deleteCurrentAcc);
$('btnResetAcc').addEventListener('click',resetCurrentAcc);

// Public API
window.app={
    closeRes(){$('rov').classList.remove('on');render()},
    switchMonth(m,y){cMonth=m;cYear=y;updateCharts();genMonthNav()},
    switchAcc(id){APP.currentId=id;closeSh('shAcc');dbSave().then(()=>{render();updateCharts();genMonthNav()})}
};

document.addEventListener('DOMContentLoaded',init);
})();
</script>
</body>
</html>
